drop database if exists mybnb;
create database mybnb;
use mybnb;

-- Need table declaration before trigger
drop table if exists users;
create table Users (sin INTEGER NOT NULL PRIMARY KEY, name varchar(100) NOT NULL, postalcode varchar(6) NOT NULL, city varchar(100) NOT NULL, country varchar(60) NOT NULL, dob DATE NOT NULL, occupation varchar(100), date_joining DATE DEFAULT (CURRENT_DATE), age INTEGER DEFAULT (TIMESTAMPDIFF(YEAR,dob,date_joining)) NOT NULL, CHECK (age >= 18)) ENGINE INNODB;

DROP TRIGGER IF EXISTS userIns;
CREATE TRIGGER userIns BEFORE INSERT ON Users FOR EACH ROW BEGIN DECLARE msg VARCHAR(255); IF NEW.age < 18 THEN SET msg = 'Constraints violated!'; SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg; END IF; END;

-- Need table declaration after trigger to fix constraint error
drop table if exists users;
create table Users (sin INTEGER NOT NULL PRIMARY KEY, name varchar(100) NOT NULL, postalcode varchar(6) NOT NULL, city varchar(100) NOT NULL, country varchar(60) NOT NULL, dob DATE NOT NULL, occupation varchar(100), date_joining DATE DEFAULT (CURRENT_DATE), age INTEGER DEFAULT (TIMESTAMPDIFF(YEAR,dob,date_joining)) NOT NULL, CHECK (age >= 18)) ENGINE INNODB;


-- Populate users table with data
INSERT INTO Users (sin,name,postalcode,city,country,dob,occupation) VALUES ('12345','John Smith','DEF456','Toronto','Canada','1989-02-23','Locksmith');
INSERT INTO Users (sin,name,postalcode,city,country,dob,occupation) VALUES ('123456','John Smith Jr.','DEF456','Toronto','Canada','2004-02-23','Student');